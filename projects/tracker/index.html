<!DOCTYPE html>
<html lang="pl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Wydatkow â€” Kacper</title>
    <style>
        :root[data-theme="dark"] {
            --bg: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-input: #16213e;
            --border: #2a2a4a;
            --text: #e0e0e0;
            --text-muted: #8888aa;
            --accent: #6c5ce7;
            --accent-hover: #a29bfe;
            --toggle-bg: #2a2a4a;
            --shadow: rgba(0,0,0,0.3);
            --income: #00b894;
            --income-bg: rgba(0,184,148,0.1);
            --expense: #e74c3c;
            --expense-bg: rgba(231,76,60,0.1);
        }
        :root[data-theme="light"] {
            --bg: #f0f2f5;
            --bg-card: #ffffff;
            --bg-input: #f8f9fa;
            --border: #ddd;
            --text: #1a1a2e;
            --text-muted: #666;
            --accent: #6c5ce7;
            --accent-hover: #5a4bd1;
            --toggle-bg: #ddd;
            --shadow: rgba(0,0,0,0.1);
            --income: #00b894;
            --income-bg: rgba(0,184,148,0.08);
            --expense: #e74c3c;
            --expense-bg: rgba(231,76,60,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .app-header h1 {
            font-size: 1.4rem;
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .theme-toggle {
            background: var(--toggle-bg);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, transform 0.2s;
        }

        .theme-toggle:hover { transform: scale(1.1); }
        [data-theme="dark"] .icon-light { display: none; }
        [data-theme="dark"] .icon-dark { display: inline; }
        [data-theme="light"] .icon-light { display: inline; }
        [data-theme="light"] .icon-dark { display: none; }

        /* Summary cards */
        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1rem;
            text-align: center;
            transition: background 0.3s, border-color 0.3s, transform 0.2s;
        }

        .summary-card:hover { transform: translateY(-2px); }

        .summary-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3rem;
        }

        .summary-value {
            font-size: 1.3rem;
            font-weight: 800;
        }

        .summary-value.balance-pos { color: var(--income); }
        .summary-value.balance-neg { color: var(--expense); }
        .summary-value.income { color: var(--income); }
        .summary-value.expense { color: var(--expense); }

        /* Chart */
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            transition: background 0.3s, border-color 0.3s;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .chart-header h2 {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .chart-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 3px;
        }

        .chart-tab {
            padding: 0.3rem 0.7rem;
            border: none;
            background: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .chart-tab.active {
            background: var(--accent);
            color: white;
        }

        .chart-container {
            position: relative;
            height: 200px;
        }

        canvas { display: block; }

        /* Donut chart legend */
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
            margin-top: 0.75rem;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Add form */
        .add-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            transition: background 0.3s, border-color 0.3s;
        }

        .add-card h2 {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .form-group.full { grid-column: 1 / -1; }

        .form-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            padding: 0.65rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.3s, background 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group input::placeholder { color: var(--text-muted); }

        .type-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .type-btn {
            flex: 1;
            padding: 0.6rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .type-btn.active-income {
            border-color: var(--income);
            color: var(--income);
            background: var(--income-bg);
        }

        .type-btn.active-expense {
            border-color: var(--expense);
            color: var(--expense);
            background: var(--expense-bg);
        }

        .submit-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .submit-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        /* Filter */
        .filter-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.35rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .filter-select {
            padding: 0.35rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.8rem;
            margin-left: auto;
        }

        /* Transactions list */
        .transactions-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            transition: background 0.3s, border-color 0.3s;
        }

        .transactions-card h2 {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .transaction {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            transition: border-color 0.3s;
        }

        .transaction:last-child { border-bottom: none; }

        .tx-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .tx-icon.income { background: var(--income-bg); }
        .tx-icon.expense { background: var(--expense-bg); }

        .tx-info { flex: 1; min-width: 0; }

        .tx-name {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tx-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .tx-amount {
            font-size: 1rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .tx-amount.income { color: var(--income); }
        .tx-amount.expense { color: var(--expense); }

        .tx-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem;
            border-radius: 6px;
            transition: all 0.2s;
            opacity: 0;
        }

        .transaction:hover .tx-delete { opacity: 1; }
        .tx-delete:hover { color: var(--expense); background: var(--expense-bg); }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-state .empty-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        /* Back link */
        .back-link {
            display: block;
            text-align: center;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85rem;
            padding: 1rem 0;
            transition: color 0.3s;
        }

        .back-link:hover { color: var(--accent); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Responsive */
        @media (max-width: 550px) {
            .summary { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .summary-card { padding: 0.75rem; }
            .summary-value { font-size: 1.1rem; }
            .tx-delete { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1>Tracker Wydatkow</h1>
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Zmien motyw">
                    <span class="icon-dark">&#9790;</span>
                    <span class="icon-light">&#9728;</span>
                </button>
            </div>
        </div>

        <!-- Summary -->
        <div class="summary">
            <div class="summary-card">
                <div class="summary-label">Bilans</div>
                <div class="summary-value" id="balance">0,00 zl</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Przychody</div>
                <div class="summary-value income" id="totalIncome">0,00 zl</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Wydatki</div>
                <div class="summary-value expense" id="totalExpense">0,00 zl</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h2>Podsumowanie</h2>
                <div class="chart-tabs">
                    <button class="chart-tab active" data-chart="donut">Kategorie</button>
                    <button class="chart-tab" data-chart="bar">Miesiace</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="chartCanvas"></canvas>
            </div>
            <div class="chart-legend" id="chartLegend"></div>
        </div>

        <!-- Add form -->
        <div class="add-card">
            <h2>Dodaj transakcje</h2>
            <div class="type-row">
                <button class="type-btn active-expense" id="typeExpense" data-type="expense">Wydatek</button>
                <button class="type-btn" id="typeIncome" data-type="income">Przychod</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Nazwa</label>
                    <input type="text" id="txName" placeholder="np. Zakupy spozywcze">
                </div>
                <div class="form-group">
                    <label>Kwota (zl)</label>
                    <input type="number" id="txAmount" placeholder="0.00" min="0.01" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Kategoria</label>
                    <select id="txCategory">
                        <option value="Jedzenie">Jedzenie</option>
                        <option value="Transport">Transport</option>
                        <option value="Rozrywka">Rozrywka</option>
                        <option value="Rachunki">Rachunki</option>
                        <option value="Zakupy">Zakupy</option>
                        <option value="Zdrowie">Zdrowie</option>
                        <option value="Edukacja">Edukacja</option>
                        <option value="Wyplata">Wyplata</option>
                        <option value="Freelance">Freelance</option>
                        <option value="Inne">Inne</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="txDate">
                </div>
            </div>
            <button class="submit-btn" id="addBtn">Dodaj transakcje</button>
        </div>

        <!-- Filters + transactions -->
        <div class="transactions-card">
            <h2>Historia transakcji</h2>
            <div class="filter-row">
                <button class="filter-btn active" data-filter="all">Wszystko</button>
                <button class="filter-btn" data-filter="income">Przychody</button>
                <button class="filter-btn" data-filter="expense">Wydatki</button>
                <select class="filter-select" id="monthFilter">
                    <option value="all">Wszystkie miesiace</option>
                </select>
            </div>
            <div id="transactionsList"></div>
        </div>

        <a href="../../index.html" class="back-link">&larr; Powrot do portfolio</a>
    </div>

    <script>
        // ---- Config ----
        const CATEGORY_COLORS = {
            'Jedzenie': '#ff6b6b',
            'Transport': '#feca57',
            'Rozrywka': '#ff9ff3',
            'Rachunki': '#54a0ff',
            'Zakupy': '#5f27cd',
            'Zdrowie': '#01a3a4',
            'Edukacja': '#f368e0',
            'Wyplata': '#00b894',
            'Freelance': '#6c5ce7',
            'Inne': '#636e72'
        };

        const CATEGORY_ICONS = {
            'Jedzenie': '&#127829;',
            'Transport': '&#128663;',
            'Rozrywka': '&#127916;',
            'Rachunki': '&#128196;',
            'Zakupy': '&#128717;',
            'Zdrowie': '&#128138;',
            'Edukacja': '&#128218;',
            'Wyplata': '&#128176;',
            'Freelance': '&#128187;',
            'Inne': '&#128230;'
        };

        // ---- State ----
        let transactions = [];
        let currentType = 'expense';
        let currentFilter = 'all';
        let currentChart = 'donut';

        // ---- Elements ----
        const balanceEl = document.getElementById('balance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const listEl = document.getElementById('transactionsList');
        const chartCanvas = document.getElementById('chartCanvas');
        const chartCtx = chartCanvas.getContext('2d');
        const legendEl = document.getElementById('chartLegend');
        const monthFilter = document.getElementById('monthFilter');

        // ---- Storage ----
        function load() {
            try { transactions = JSON.parse(localStorage.getItem('tracker-data')) || []; }
            catch { transactions = []; }
        }

        function save() {
            localStorage.setItem('tracker-data', JSON.stringify(transactions));
        }

        // ---- Theme ----
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('tracker-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);

        themeToggle.addEventListener('click', () => {
            const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('tracker-theme', next);
            drawChart();
        });

        // ---- Type toggle ----
        const typeExpense = document.getElementById('typeExpense');
        const typeIncome = document.getElementById('typeIncome');

        typeExpense.addEventListener('click', () => {
            currentType = 'expense';
            typeExpense.className = 'type-btn active-expense';
            typeIncome.className = 'type-btn';
        });

        typeIncome.addEventListener('click', () => {
            currentType = 'income';
            typeIncome.className = 'type-btn active-income';
            typeExpense.className = 'type-btn';
        });

        // ---- Add transaction ----
        document.getElementById('txDate').valueAsDate = new Date();

        document.getElementById('addBtn').addEventListener('click', () => {
            const name = document.getElementById('txName').value.trim();
            const amount = parseFloat(document.getElementById('txAmount').value);
            const category = document.getElementById('txCategory').value;
            const date = document.getElementById('txDate').value;

            if (!name || !amount || amount <= 0 || !date) return;

            transactions.push({
                id: Date.now().toString(36) + Math.random().toString(36).slice(2, 5),
                name,
                amount,
                category,
                date,
                type: currentType
            });

            save();
            render();

            document.getElementById('txName').value = '';
            document.getElementById('txAmount').value = '';
            document.getElementById('txName').focus();
        });

        // ---- Filters ----
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderList();
            });
        });

        monthFilter.addEventListener('change', renderList);

        // ---- Chart tabs ----
        document.querySelectorAll('.chart-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentChart = tab.dataset.chart;
                drawChart();
            });
        });

        // ---- Delete ----
        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            save();
            render();
        }

        // ---- Format ----
        function formatMoney(n) {
            return n.toFixed(2).replace('.', ',') + ' zl';
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}`;
        }

        // ---- Render ----
        function render() {
            updateSummary();
            renderList();
            updateMonthFilter();
            drawChart();
        }

        function updateSummary() {
            const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const balance = income - expense;

            balanceEl.textContent = formatMoney(balance);
            balanceEl.className = 'summary-value ' + (balance >= 0 ? 'balance-pos' : 'balance-neg');
            totalIncomeEl.textContent = '+' + formatMoney(income);
            totalExpenseEl.textContent = '-' + formatMoney(expense);
        }

        function renderList() {
            const monthVal = monthFilter.value;
            let filtered = [...transactions];

            if (currentFilter !== 'all') {
                filtered = filtered.filter(t => t.type === currentFilter);
            }

            if (monthVal !== 'all') {
                filtered = filtered.filter(t => t.date.slice(0, 7) === monthVal);
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">&#128203;</div>
                        <p>Brak transakcji</p>
                    </div>`;
                return;
            }

            listEl.innerHTML = filtered.map(t => `
                <div class="transaction">
                    <div class="tx-icon ${t.type}">${CATEGORY_ICONS[t.category] || '&#128230;'}</div>
                    <div class="tx-info">
                        <div class="tx-name">${escapeHtml(t.name)}</div>
                        <div class="tx-meta">${t.category} &middot; ${formatDate(t.date)}</div>
                    </div>
                    <div class="tx-amount ${t.type}">${t.type === 'income' ? '+' : '-'}${formatMoney(t.amount)}</div>
                    <button class="tx-delete" onclick="deleteTransaction('${t.id}')" title="Usun">&#10005;</button>
                </div>
            `).join('');
        }

        function updateMonthFilter() {
            const months = new Set(transactions.map(t => t.date.slice(0, 7)));
            const sorted = [...months].sort().reverse();
            const current = monthFilter.value;

            monthFilter.innerHTML = '<option value="all">Wszystkie miesiace</option>';
            sorted.forEach(m => {
                const [y, mo] = m.split('-');
                const names = ['Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie','Wrz','Paz','Lis','Gru'];
                const label = names[parseInt(mo) - 1] + ' ' + y;
                monthFilter.innerHTML += `<option value="${m}" ${m === current ? 'selected' : ''}>${label}</option>`;
            });
        }

        // ---- Charts ----
        function drawChart() {
            const rect = chartCanvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            chartCanvas.width = rect.width * dpr;
            chartCanvas.height = rect.height * dpr;
            chartCanvas.style.width = rect.width + 'px';
            chartCanvas.style.height = rect.height + 'px';
            chartCtx.scale(dpr, dpr);

            const w = rect.width;
            const h = rect.height;

            chartCtx.clearRect(0, 0, w, h);

            if (currentChart === 'donut') {
                drawDonut(w, h);
            } else {
                drawBar(w, h);
            }
        }

        function drawDonut(w, h) {
            const expenses = transactions.filter(t => t.type === 'expense');
            const catTotals = {};
            expenses.forEach(t => {
                catTotals[t.category] = (catTotals[t.category] || 0) + t.amount;
            });

            const entries = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
            const total = entries.reduce((s, e) => s + e[1], 0);

            legendEl.innerHTML = '';

            if (total === 0) {
                const textColor = getCSS('--text-muted');
                chartCtx.fillStyle = textColor;
                chartCtx.font = '14px Segoe UI, sans-serif';
                chartCtx.textAlign = 'center';
                chartCtx.fillText('Brak danych', w / 2, h / 2);
                return;
            }

            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(w, h) / 2 - 20;
            const innerRadius = radius * 0.6;
            let startAngle = -Math.PI / 2;

            entries.forEach(([cat, amount]) => {
                const slice = (amount / total) * Math.PI * 2;
                const color = CATEGORY_COLORS[cat] || '#636e72';

                chartCtx.beginPath();
                chartCtx.moveTo(cx, cy);
                chartCtx.arc(cx, cy, radius, startAngle, startAngle + slice);
                chartCtx.closePath();
                chartCtx.fillStyle = color;
                chartCtx.fill();

                startAngle += slice;

                const pct = Math.round((amount / total) * 100);
                legendEl.innerHTML += `
                    <div class="legend-item">
                        <div class="legend-dot" style="background:${color}"></div>
                        ${cat} (${pct}%)
                    </div>`;
            });

            // Inner circle (donut hole)
            chartCtx.beginPath();
            chartCtx.arc(cx, cy, innerRadius, 0, Math.PI * 2);
            chartCtx.fillStyle = getCSS('--bg-card');
            chartCtx.fill();

            // Center text
            chartCtx.fillStyle = getCSS('--text');
            chartCtx.font = 'bold 16px Segoe UI, sans-serif';
            chartCtx.textAlign = 'center';
            chartCtx.textBaseline = 'middle';
            chartCtx.fillText(formatMoney(total), cx, cy);
        }

        function drawBar(w, h) {
            legendEl.innerHTML = '';

            const monthData = {};
            transactions.forEach(t => {
                const key = t.date.slice(0, 7);
                if (!monthData[key]) monthData[key] = { income: 0, expense: 0 };
                monthData[key][t.type] += t.amount;
            });

            const months = Object.keys(monthData).sort().slice(-6);

            if (months.length === 0) {
                chartCtx.fillStyle = getCSS('--text-muted');
                chartCtx.font = '14px Segoe UI, sans-serif';
                chartCtx.textAlign = 'center';
                chartCtx.fillText('Brak danych', w / 2, h / 2);
                return;
            }

            const maxVal = Math.max(...months.map(m => Math.max(monthData[m].income, monthData[m].expense)), 1);
            const padding = { top: 10, bottom: 35, left: 10, right: 10 };
            const chartW = w - padding.left - padding.right;
            const chartH = h - padding.top - padding.bottom;
            const groupW = chartW / months.length;
            const barW = groupW * 0.3;
            const gap = groupW * 0.05;

            const monthNames = ['Sty','Lut','Mar','Kwi','Maj','Cze','Lip','Sie','Wrz','Paz','Lis','Gru'];

            months.forEach((m, i) => {
                const data = monthData[m];
                const x = padding.left + i * groupW + groupW / 2;

                // Income bar
                const incH = (data.income / maxVal) * chartH;
                const incX = x - barW - gap / 2;
                const incY = padding.top + chartH - incH;
                chartCtx.fillStyle = getCSS('--income');
                chartCtx.beginPath();
                chartCtx.roundRect(incX, incY, barW, incH, [4, 4, 0, 0]);
                chartCtx.fill();

                // Expense bar
                const expH = (data.expense / maxVal) * chartH;
                const expX = x + gap / 2;
                const expY = padding.top + chartH - expH;
                chartCtx.fillStyle = getCSS('--expense');
                chartCtx.beginPath();
                chartCtx.roundRect(expX, expY, barW, expH, [4, 4, 0, 0]);
                chartCtx.fill();

                // Label
                const [, mo] = m.split('-');
                chartCtx.fillStyle = getCSS('--text-muted');
                chartCtx.font = '11px Segoe UI, sans-serif';
                chartCtx.textAlign = 'center';
                chartCtx.fillText(monthNames[parseInt(mo) - 1], x, h - 8);
            });

            legendEl.innerHTML = `
                <div class="legend-item"><div class="legend-dot" style="background:var(--income)"></div>Przychody</div>
                <div class="legend-item"><div class="legend-dot" style="background:var(--expense)"></div>Wydatki</div>
            `;
        }

        function getCSS(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ---- Resize ----
        window.addEventListener('resize', drawChart);

        // ---- Init ----
        load();
        render();
    </script>
</body>
</html>
